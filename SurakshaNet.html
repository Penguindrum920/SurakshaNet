<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SurakshaSetu - Standalone Command Center</title>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- TomTom Maps SDK (replace with your API key below) -->
    <link rel="stylesheet" href="https://api.tomtom.com/maps-sdk-for-web/6.17.0/maps/maps.css" />
    <script src="https://api.tomtom.com/maps-sdk-for-web/6.17.0/maps/maps-web.min.js"></script>
    <style>
        /* Search suggestion dropdown */
        .search-suggestions { position: absolute; background: var(--bg-gray-800); border: 1px solid var(--border-gray-700); width: 288px; max-height: 220px; overflow-y: auto; border-radius: 6px; margin-top: 6px; z-index: 200; }
        .search-suggestions div { padding: 8px 10px; cursor: pointer; color: var(--text-gray-200); }
        .search-suggestions div:hover { background: rgba(255,255,255,0.02); }
        /* CSS Reset & Variables */
        :root {
            --bg-gray-900: #111827; --bg-gray-800: #1f2937; --bg-gray-700: #374151; --border-gray-700: #4b5563;
            --text-white: #f9fafb; --text-gray-200: #e5e7eb; --text-gray-300: #d1d5db; --text-gray-400: #9ca3af;
            --cyan-500: #06b6d4; --cyan-600: #0891b2; --red-500: #ef4444; --red-600: #dc2626;
            --yellow-500: #eab308; --blue-500: #3b82f6; --green-500: #22c55e;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        html { scroll-behavior: smooth; }
        body {
            font-family: 'Inter', sans-serif; background-color: var(--bg-gray-900);
            color: var(--text-gray-200); overflow: hidden;
        }
        button, input, textarea { font-family: inherit; font-size: 100%; }
        .hidden { display: none !important; }

        /* Layout */
        .app-container { display: flex; height: 100vh; }
        .sidebar { width: 256px; flex-shrink: 0; background-color: var(--bg-gray-900); border-right: 1px solid var(--border-gray-700); display: flex; flex-direction: column; }
        .main-content { flex-grow: 1; display: flex; flex-direction: column; overflow: hidden; }
        .header { height: 80px; flex-shrink: 0; background-color: rgba(17, 24, 39, 0.8); backdrop-filter: blur(4px); border-bottom: 1px solid var(--border-gray-700); display: flex; align-items: center; justify-content: space-between; padding: 0 24px; }
        .page-content { flex-grow: 1; overflow-y: auto; padding: 24px; }

        /* Sidebar */
        .sidebar-header { height: 80px; display: flex; align-items: center; justify-content: flex-start; padding: 0 16px; border-bottom: 1px solid var(--border-gray-700); }
        .sidebar-header .logo-icon { color: var(--cyan-500); }
        .sidebar-header .logo-text { margin-left: 12px; font-size: 1.25rem; font-weight: 700; color: var(--text-white); }
        .sidebar-menu { flex-grow: 1; padding: 16px; display: flex; flex-direction: column; gap: 8px; }
        .nav-link { display: flex; align-items: center; padding: 12px; border-radius: 8px; color: var(--text-gray-300); text-decoration: none; transition: background-color 0.2s; }
        .nav-link:hover { background-color: var(--bg-gray-700); }
        .nav-link.active { background-color: rgba(8, 145, 178, 0.2); color: var(--text-white); font-weight: 600; }
        .nav-link span { margin-left: 16px; }
        .sidebar-stats { padding: 16px; display: flex; flex-direction: column; gap: 12px; }
        .stat-card { background-color: rgba(55, 65, 81, 0.5); padding: 12px; border-radius: 8px; display: flex; align-items: center; gap: 12px; }
        .stat-card-value { font-size: 1.25rem; font-weight: 700; color: var(--text-white); }
        .stat-card-label { font-size: 0.875rem; color: var(--text-gray-400); }

        /* Header */
        .header-title h1 { font-size: 1.5rem; font-weight: 700; }
        .header-title p { font-size: 0.875rem; color: var(--text-gray-400); }
        .header-actions { display: flex; align-items: center; gap: 16px; }
        .search-input { background-color: var(--bg-gray-800); border: 1px solid var(--border-gray-700); border-radius: 8px; color: var(--text-white); padding: 8px 12px 8px 36px; width: 288px; }
        .search-wrapper { position: relative; }
        .search-wrapper i { position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: var(--text-gray-400); }
        .btn { padding: 8px 16px; border-radius: 8px; border: none; font-weight: 600; cursor: pointer; transition: background-color 0.2s; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .btn-danger { background-color: var(--red-600); color: var(--text-white); box-shadow: 0 4px 14px 0 rgba(220, 38, 38, 0.2); }
        .btn-danger:hover { background-color: var(--red-500); }

        /* Common Content Styles */
        .content-card { background-color: var(--bg-gray-800); border-radius: 12px; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); }
        .card-header { padding: 16px; border-bottom: 1px solid var(--border-gray-700); }
        .card-header h2 { font-size: 1.25rem; font-weight: 600; }
        .card-body { padding: 24px; }
        
        /* Map & Dashboard */
        .map-wrapper { height: 85vh; display: flex; flex-direction: column; }
        #map-container { flex-grow: 1; position: relative; background-color: var(--bg-gray-700); }
        .map-marker { position: absolute; transform: translate(-50%, -50%); cursor: pointer; transition: transform 0.2s; }
        .map-marker:hover { transform: translate(-50%, -50%) scale(1.3); z-index: 10; }
        .pulse { animation: pulse-animation 2s infinite; border-radius: 50%; }
        @keyframes pulse-animation { 0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); } 70% { box-shadow: 0 0 0 20px rgba(239, 68, 68, 0); } 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); } }
        
        /* Alerts Table */
        .alerts-table { width: 100%; border-collapse: collapse; }
        .alerts-table th, .alerts-table td { padding: 12px 16px; text-align: left; border-bottom: 1px solid var(--border-gray-700); }
        .alerts-table th { color: var(--text-gray-400); font-weight: 600; font-size: 0.875rem; }
        .status-badge { padding: 4px 8px; border-radius: 12px; font-size: 0.75rem; font-weight: 600; }
        .status-new { background-color: rgba(234, 179, 8, 0.1); color: var(--yellow-500); }

        /* Modals */
        .modal-overlay { position: fixed; inset: 0; background-color: rgba(0,0,0,0.6); backdrop-filter: blur(4px); display: flex; align-items: center; justify-content: center; z-index: 50; padding: 16px; }
        .modal-content { background-color: var(--bg-gray-800); border: 1px solid var(--border-gray-700); border-radius: 16px; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25); width: 100%; max-width: 500px; max-height: 90vh; overflow-y: auto; }
        .modal-header { padding: 24px; border-bottom: 1px solid var(--border-gray-700); display: flex; align-items: center; gap: 16px; }
        .modal-header h2 { font-size: 1.5rem; font-weight: 700; }
        .modal-body { padding: 24px; color: var(--text-gray-300); line-height: 1.6; }
        .modal-body p { margin-bottom: 1rem; }
        .modal-footer { padding: 16px; background-color: rgba(17, 24, 39, 0.5); border-top: 1px solid var(--border-gray-700); display: flex; justify-content: flex-end; gap: 12px; }
        .btn-secondary { background-color: var(--bg-gray-700); color: var(--text-white); }
        .btn-secondary:hover { background-color: var(--border-gray-700); }

        /* Toast Notifications & Banner */
        #toast-container { position: fixed; top: 20px; right: 20px; z-index: 100; display: flex; flex-direction: column; gap: 10px; }
        .toast { background-color: var(--bg-gray-800); padding: 12px 16px; border-radius: 8px; border-left: 4px solid; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); display: flex; align-items: center; opacity: 0; transform: translateX(100%); transition: all 0.5s; }
        .toast.show { opacity: 1; transform: translateX(0); }
        .toast.success { border-color: var(--green-500); }
        .toast.danger { border-color: var(--red-500); }
        #critical-incident-banner { background-color: var(--red-600); color: var(--text-white); text-align: center; padding: 12px; font-weight: 700; animation: flash-animation 1.5s infinite; }
        @keyframes flash-animation { 50% { background-color: var(--red-500); } }

    </style>
</head>
<body>
    <div id="toast-container"></div>

    <div class="app-container">
        <!-- Sidebar Navigation -->
        <nav class="sidebar">
            <div class="sidebar-header">
                <i data-lucide="shield-check" class="logo-icon" style="width:32px; height:32px;"></i>
                <span class="logo-text">SurakshaSetu</span>
            </div>
            <div class="sidebar-menu">
                <a href="#dashboard" class="nav-link active"><i data-lucide="layout-dashboard"></i><span>Live Dashboard</span></a>
                <a href="#alerts" class="nav-link"><i data-lucide="shield-alert"></i><span>Alert Management</span></a>
                <a href="#convoys" class="nav-link"><i data-lucide="bus"></i><span>Convoy Management</span></a>
                <a href="#comms" class="nav-link"><i data-lucide="message-square"></i><span>Communications</span></a>
                <a href="#analytics" class="nav-link"><i data-lucide="bar-chart-2"></i><span>Analytics & Reports</span></a>
            </div>
            <div class="sidebar-stats">
                <div class="stat-card">
                    <i data-lucide="users" style="color:var(--blue-500)"></i>
                    <div>
                        <div id="total-tourists" class="stat-card-value">0</div>
                        <div class="stat-card-label">Active Tourists</div>
                    </div>
                </div>
                <div class="stat-card">
                    <i data-lucide="siren" style="color:var(--red-500)"></i>
                    <div>
                        <div id="active-alerts" class="stat-card-value">0</div>
                        <div class="stat-card-label">Active Alerts</div>
                    </div>
                </div>
            </div>
        </nav>

        <!-- Main Content -->
        <main class="main-content">
            <div id="critical-incident-banner" class="hidden">CRITICAL INCIDENT IN PROGRESS</div>
            <header class="header">
                <div class="header-title">
                    <h1 id="page-title">Live Operations Map</h1>
                    <p id="current-time">Loading time...</p>
                </div>
                <div class="header-actions">
                    <div class="search-wrapper">
                         <i data-lucide="search" style="width:18px; height:18px;"></i>
                        <input id="search-input" type="text" placeholder="Search Tourist ID, Vehicle..." class="search-input" autocomplete="off">
                        <div id="search-suggestions" class="search-suggestions hidden"></div>
                    </div>
                    <!-- Auto-alert Controls -->
                    <div style="display:flex; align-items:center; gap:8px;">
                        <label style="color:var(--text-gray-400); font-size:0.85rem;">Auto Alerts</label>
                        <input id="auto-alert-toggle" type="checkbox" title="Enable automatic alerts" />
                        <select id="auto-alert-mode" title="Mode" style="background:var(--bg-gray-800); color:var(--text-white); border:1px solid var(--border-gray-700); border-radius:6px; padding:6px;">
                            <option value="sos">SOS (panic)</option>
                            <option value="safety">Safety Check-in</option>
                        </select>
                        <input id="auto-alert-interval" type="number" min="5" value="30" title="Interval seconds" style="width:70px; background:var(--bg-gray-800); color:var(--text-white); border:1px solid var(--border-gray-700); border-radius:6px; padding:6px;" />
                    </div>
                    <button id="critical-protocol-btn" class="btn btn-danger">
                        <i data-lucide="siren"></i>
                        <span>Initiate Critical Protocol</span>
                    </button>
                </div>
            </header>

            <div class="page-content">
                <!-- Dashboard View -->
                <div id="dashboard-view" class="main-view">
                    <div class="content-card map-wrapper">
                        <div class="card-header"><h2>Pahalgam Region - Live View</h2></div>
                        <div id="map-container">
                                <!-- TomTom map will mount here. If TomTom fails to load, show PNG fallback. -->
                                <div id="tomtom-map" style="position:absolute; inset:0; width:100%; height:100%;"></div>
                                <img id="map-fallback-img" src="pahalgam.png" alt="Pahalgam Map" style="position:absolute; inset:0; width:100%; height:100%; object-fit:cover; opacity:0.9; display:block;" />
                                <div id="map-elements" style="position:absolute; inset:0;"></div>
                        </div>
                    </div>
                </div>
                <!-- Alerts View -->
                <div id="alerts-view" class="main-view hidden">
                    <div class="content-card">
                        <div class="card-header"><h2>Alert Management</h2></div>
                        <div class="card-body">
                            <table class="alerts-table">
                                <thead><tr><th>ID</th><th>Type</th><th>Details</th><th>Timestamp</th><th>Status</th></tr></thead>
                                <tbody id="alerts-table-body"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
                <!-- Convoys View -->
                <div id="convoys-view" class="main-view hidden"><div class="content-card"><div class="card-header"><h2>Convoy Management</h2></div><div class="card-body"><p>Convoy management interface would be here.</p></div></div></div>
                <!-- Comms View -->
                <div id="comms-view" class="main-view hidden"><div class="content-card"><div class="card-header"><h2>Communication Center</h2></div><div class="card-body"><p>Send a geo-fenced broadcast message to all tourists in a specified area.</p><textarea style="width:100%; height: 150px; margin-top:1rem; padding:12px; border-radius:8px; background-color:var(--bg-gray-700); color:var(--text-white); border: 1px solid var(--border-gray-700); resize:vertical;" placeholder="E.g., 'Active threat reported near Betaab Valley. Shelter in place immediately.'"></textarea><button class="btn btn-secondary" style="margin-top:1rem; background-color: var(--cyan-600);">Send Broadcast</button></div></div></div>
                <!-- Analytics View -->
                <div id="analytics-view" class="main-view hidden"><div class="content-card"><div class="card-header"><h2>Analytics & Reports</h2></div><div class="card-body"><canvas id="alerts-chart"></canvas></div></div></div>
            </div>
        </main>
    </div>

    <!-- Modals -->
    <div id="details-modal" class="modal-overlay hidden" onclick="closeModal('details-modal')">
        <div class="modal-content" onclick="event.stopPropagation()"> <div id="details-modal-content"></div> </div>
    </div>
    <div id="critical-incident-modal" class="modal-overlay hidden" onclick="closeModal('critical-incident-modal')">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="modal-header"><i data-lucide="alert-triangle" style="width: 32px; height: 32px; color: var(--yellow-500);"></i><h2>Confirm Critical Incident Protocol</h2></div>
            <div class="modal-body"><p>You are about to trigger a <strong>region-wide critical incident alert.</strong></p><p>This action will immediately notify all available emergency response units and broadcast an emergency message to all tourists in the affected zone.</p><p style="font-weight: 700; color: var(--text-white);">This action cannot be undone. Are you sure you want to proceed?</p></div>
            <div class="modal-footer"><button id="cancel-protocol-btn" class="btn btn-secondary">Cancel</button><button id="confirm-protocol-btn" class="btn btn-danger">Confirm Protocol Activation</button></div>
        </div>
    </div>

    <script>
    // --- INITIALIZATION ---
    lucide.createIcons();
    const state = { tourists: [], alerts: [], charts: {} };

    // --- DOM ELEMENTS ---
    const timeElement = document.getElementById('current-time');
    const pageTitle = document.getElementById('page-title');
    const totalTouristsEl = document.getElementById('total-tourists');
    const activeAlertsEl = document.getElementById('active-alerts');
    const mapElementsContainer = document.getElementById('map-elements');
    const detailsModal = document.getElementById('details-modal');
    const detailsModalContent = document.getElementById('details-modal-content');
    const criticalProtocolBtn = document.getElementById('critical-protocol-btn');
    const criticalIncidentModal = document.getElementById('critical-incident-modal');
    const confirmProtocolBtn = document.getElementById('confirm-protocol-btn');
    const cancelProtocolBtn = document.getElementById('cancel-protocol-btn');
    const criticalIncidentBanner = document.getElementById('critical-incident-banner');
    const sidebarMenu = document.querySelector('.sidebar-menu');
    const mainViews = document.querySelectorAll('.main-view');
    const alertsTableBody = document.getElementById('alerts-table-body');
    // Auto alert controls
    const autoAlertToggle = document.getElementById('auto-alert-toggle');
    const autoAlertMode = document.getElementById('auto-alert-mode');
    const autoAlertIntervalInput = document.getElementById('auto-alert-interval');

    let autoAlertTimer = null;

    // --- MAP STATE & TOMTOM HELPERS ---
    const mapState = { map: null, markers: { tourists: [], convoys: [], police: [], hospitals: [] }, tomtomKey: 'cJnZNF2LjNfGqNHMfPzX2Js7bkoG51FI' };
    const searchInput = document.getElementById('search-input');
    const searchSuggestions = document.getElementById('search-suggestions');

    function initTomTomMap() {
        const key = mapState.tomtomKey; // set mapState.tomtomKey = 'YOUR_KEY' to enable
        if (!key) { console.warn('TomTom API key not set â€” continuing with image fallback'); return; }
        function createMap() {
            try {
                if (!window.tt) { console.error('TomTom SDK not available after loading.'); return; }
                tt.setProductInfo('SurakshaSetu', '1.0');
                mapState.map = tt.map({ key, container: 'tomtom-map', style: 'tomtom://vector/1/basic-main', center: [75.315, 34.011], zoom: 12 });
                mapState.map.on('load', () => {
                    // hide fallback image once TomTom map is ready
                    const img = document.getElementById('map-fallback-img'); if (img) img.style.display = 'none';
                    renderAllMarkersOnMap();
                });
            } catch (err) { console.error('Error initializing TomTom map', err); }
        }

        // CSS and JS candidates (try several hosts in case one is blocked)
        const cssCandidates = [
            'https://api.tomtom.com/maps-sdk-for-web/6.17.0/maps/maps.css',
            'https://cdn.jsdelivr.net/npm/@tomtom-international/web-sdk-maps@6.17.0/dist/maps.css'
        ];
        const jsCandidates = [
            'https://api.tomtom.com/maps-sdk-for-web/6.17.0/maps/maps-web.min.js',
            'https://cdn.jsdelivr.net/npm/@tomtom-international/web-sdk-maps@6.17.0/dist/maps-web.min.js'
        ];

        // Ensure CSS is present (try primary then fallback)
        if (!document.querySelector('link[data-tomtom-dynamic-css]')) {
            const link = document.createElement('link');
            link.setAttribute('data-tomtom-dynamic-css', '1');
            link.rel = 'stylesheet';
            link.href = cssCandidates[0];
            link.onerror = () => {
                console.warn('Primary TomTom CSS failed, trying fallback');
                link.href = cssCandidates[1];
            };
            document.head.appendChild(link);
        }

        if (window.tt) { createMap(); return; }

        // Try each JS candidate sequentially
        let idx = 0;
        function tryLoad(idx) {
            if (idx >= jsCandidates.length) {
                console.error('All TomTom SDK URLs failed to load. Using fallback overlay.');
                try { showToast('Failed to load TomTom SDK; using fallback overlay', 'danger'); } catch (e) { console.warn('Toast unavailable'); }
                // ensure fallback image is visible
                const img = document.getElementById('map-fallback-img'); if (img) img.style.display = 'block';
                return;
            }
            const url = jsCandidates[idx];
            // If script already exists for this URL, attach handlers
            const existing = document.querySelector(`script[src="${url}"]`);
            if (existing) {
                existing.onload = () => { console.log('TomTom SDK available via existing script'); try { showToast('TomTom SDK loaded', 'success'); } catch (e){}; createMap(); };
                existing.onerror = () => { console.warn('Existing script failed, trying next'); tryLoad(idx + 1); };
                return;
            }
            const s = document.createElement('script');
            s.setAttribute('data-tomtom-dynamic', '1');
            s.src = url;
            s.onload = () => { console.log('TomTom SDK loaded from', url); try { showToast('TomTom SDK loaded', 'success'); } catch (e){}; createMap(); };
            s.onerror = () => { console.warn('Failed to load TomTom SDK from', url); tryLoad(idx + 1); };
            document.head.appendChild(s);
        }
        tryLoad(0);
    }

    function addTomTomMarker(type, coords, el) {
        if (!mapState.map) return null;
        const marker = new tt.Marker({ element: el }).setLngLat(coords).addTo(mapState.map);
        mapState.markers[type].push(marker);
        return marker;
    }

    function clearTomTomMarkers() {
        if (!mapState.map) return;
        Object.keys(mapState.markers).forEach(k => { mapState.markers[k].forEach(m => m.remove()); mapState.markers[k] = []; });
    }

    function renderAllMarkersOnMap() {
        if (!mapState.map) return;
        clearTomTomMarkers();
        state.tourists.forEach(t => {
            const el = document.createElement('div'); el.innerHTML = `<i data-lucide=\"user\" style=\"color: ${t.status === 'distress' ? 'var(--red-500)' : 'var(--green-500)'}; width:28px; height:28px;\"></i>`;
            addTomTomMarker('tourists', [t.lng, t.lat], el);
        });
        mapState.convoys && mapState.convoys.forEach(c => { const el = document.createElement('div'); el.innerHTML = `<i data-lucide=\"truck\" style=\"color:var(--cyan-600); width:26px; height:26px;\"></i>`; addTomTomMarker('convoys', [c.lng, c.lat], el); });
        mapState.police && mapState.police.forEach(p => { const el = document.createElement('div'); el.innerHTML = `<i data-lucide=\"shield\" style=\"color:var(--blue-500); width:24px; height:24px;\"></i>`; addTomTomMarker('police', [p.lng, p.lat], el); });
        mapState.hospitals && mapState.hospitals.forEach(h => { const el = document.createElement('div'); el.innerHTML = `<i data-lucide=\"cross\" style=\"color:var(--red-500); width:24px; height:24px;\"></i>`; addTomTomMarker('hospitals', [h.lng, h.lat], el); });
        lucide.createIcons();
    }

    // --- SEARCH INTERACTIONS ---
    function buildSearchIndex() {
        const list = [];
        state.tourists.forEach(t => list.push({ id: t.id, type: 'tourist', obj: t }));
        (mapState.convoys || []).forEach(c => list.push({ id: c.id, type: 'convoy', obj: c }));
        (mapState.police || []).forEach(p => list.push({ id: p.id, type: 'police', obj: p }));
        (mapState.hospitals || []).forEach(h => list.push({ id: h.id, type: 'hospital', obj: h }));
        return list;
    }

    let searchIndex = [];
    searchInput.addEventListener('input', (e) => {
        const q = e.target.value.trim().toLowerCase();
        if (!q) { searchSuggestions.classList.add('hidden'); return; }
        const matches = searchIndex.filter(it => it.id.toLowerCase().includes(q) || (it.obj.name && it.obj.name.toLowerCase().includes(q))).slice(0, 8);
        searchSuggestions.innerHTML = '';
        matches.forEach(m => {
            const div = document.createElement('div'); div.textContent = `${m.id} ${m.obj.name ? '- ' + m.obj.name : ''}`;
            div.onclick = () => { searchSuggestions.classList.add('hidden'); panToItem(m); searchInput.value = div.textContent; };
            searchSuggestions.appendChild(div);
        });
        searchSuggestions.classList.toggle('hidden', matches.length === 0);
    });

    document.addEventListener('click', (e) => { if (!e.target.closest('.search-wrapper')) searchSuggestions.classList.add('hidden'); });

    function panToItem(item) {
        if (item.type === 'tourist') {
            const t = item.obj;
            if (mapState.map) mapState.map.flyTo({ center: [t.lng, t.lat], zoom: 15 }); else {
                // highlight popup in fallback
                showToast(`${t.id} at (${t.lat.toFixed(4)}, ${t.lng.toFixed(4)})`, 'success');
            }
            showDetails(t.id);
        } else {
            const o = item.obj;
            if (mapState.map) mapState.map.flyTo({ center: [o.lng, o.lat], zoom: 14 });
            showToast(`${item.type.toUpperCase()} ${o.id}`, 'success');
        }
    }

    // --- UI, TIME & NAVIGATION ---
    function updateTime() {
        timeElement.textContent = new Date().toLocaleString('en-US', { weekday: 'long', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit', second: '2-digit' });
    }
    setInterval(updateTime, 1000); updateTime();

    sidebarMenu.addEventListener('click', (e) => {
        const link = e.target.closest('.nav-link');
        if (!link) return;
        e.preventDefault();

        document.querySelector('.nav-link.active').classList.remove('active');
        link.classList.add('active');

        const targetId = link.getAttribute('href').substring(1);
        mainViews.forEach(view => view.classList.toggle('hidden', view.id !== `${targetId}-view`));
        
        pageTitle.textContent = link.querySelector('span').textContent;

        if(targetId === 'analytics' && !state.charts.alerts) {
            initAnalyticsChart();
        }
    });

    // --- MODALS ---
    function openModal(modalId) { document.getElementById(modalId).classList.remove('hidden'); }
    function closeModal(modalId) { document.getElementById(modalId).classList.add('hidden'); }
    
    function showDetails(touristId) {
        const tourist = state.tourists.find(t => t.id === touristId);
        if (!tourist) return;
        detailsModalContent.innerHTML = `<div class="modal-header"><i data-lucide="${tourist.status === 'distress' ? 'shield-alert' : 'user'}" style="width:32px; height:32px; color: ${tourist.status === 'distress' ? 'var(--red-500)' : 'var(--green-500)'};"></i><h2>Tourist Details</h2></div><div class="modal-body"><p><strong>ID:</strong> ${tourist.id}</p><p><strong>Name:</strong> ${tourist.name}</p><p><strong>Status:</strong> <span style="font-weight:bold; color: ${tourist.status === 'distress' ? 'var(--red-500)' : 'var(--green-500)'};">${tourist.status}</span></p><p><strong>Device Battery:</strong> ${tourist.battery}%</p></div><div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal('details-modal')">Close</button></div>`;
        lucide.createIcons();
        openModal('details-modal');
    }

    // --- CRITICAL INCIDENT PROTOCOL ---
    criticalProtocolBtn.addEventListener('click', () => openModal('critical-incident-modal'));
    cancelProtocolBtn.addEventListener('click', () => closeModal('critical-incident-modal'));
    confirmProtocolBtn.addEventListener('click', () => {
        closeModal('critical-incident-modal');
        showToast('Critical Incident Protocol Activated!', 'danger');
        criticalIncidentBanner.classList.remove('hidden');
        const randomTourist = state.tourists.find(t => t.status === 'safe');
        if(randomTourist) { createAlert('SOS', 'Panic Button Activated', randomTourist); }
    });

    // --- AUTOMATIC ALERTS (SOS / Safety Check-ins) ---
    function sendAutoSOS() {
        const victim = state.tourists[Math.floor(Math.random() * state.tourists.length)];
        if (!victim) return;
        createAlert('SOS', 'Automatic periodic SOS generated', victim);
        showToast(`Auto-SOS sent for ${victim.id}`, 'danger');
    }

    function performSafetyCheck() {
        // Pick a random subset of tourists and mark as checked in (or create low-priority alerts for non-responsive)
        const sample = state.tourists.slice().sort(() => 0.5 - Math.random()).slice(0, Math.max(1, Math.floor(state.tourists.length * 0.05)));
        sample.forEach(t => {
            // 90% respond ok, 10% become 'distress' and generate an alert
            if (Math.random() < 0.1) {
                createAlert('SafetyCheck-Fail', 'No response to automatic safety check', t);
            } else {
                // small toast acknowledging check-in
                showToast(`${t.id} passed safety check`, 'success');
            }
        });
    }

    function startAutoAlerts() {
        stopAutoAlerts();
        const secs = Math.max(5, parseInt(autoAlertIntervalInput.value || '30', 10));
        const mode = autoAlertMode.value;
        autoAlertTimer = setInterval(() => {
            if (mode === 'sos') sendAutoSOS(); else performSafetyCheck();
        }, secs * 1000);
        showToast(`Auto alerts started (${mode}) every ${secs}s`, 'success');
    }

    function stopAutoAlerts() {
        if (autoAlertTimer) { clearInterval(autoAlertTimer); autoAlertTimer = null; showToast('Auto alerts stopped', 'danger'); }
    }

    autoAlertToggle.addEventListener('change', () => {
        if (autoAlertToggle.checked) startAutoAlerts(); else stopAutoAlerts();
    });

    // allow changing interval/mode while running
    autoAlertIntervalInput.addEventListener('change', () => { if (autoAlertToggle.checked) startAutoAlerts(); });
    autoAlertMode.addEventListener('change', () => { if (autoAlertToggle.checked) startAutoAlerts(); });

    // --- TOAST NOTIFICATIONS ---
    function showToast(message, type = 'success') {
        const toast = document.createElement('div');
        toast.className = `toast ${type}`;
        toast.innerHTML = `<i data-lucide="${type === 'danger' ? 'siren' : 'check-circle'}" style="margin-right: 12px;"></i><span>${message}</span>`;
        document.getElementById('toast-container').appendChild(toast);
        lucide.createIcons();
        setTimeout(() => toast.classList.add('show'), 10);
        setTimeout(() => { toast.classList.remove('show'); toast.addEventListener('transitionend', () => toast.remove()); }, 5000);
    }

    // --- SIMULATION & DATA ---
    function createTourist(id) {
        const names = ["Aarav", "Vivaan", "Aditya", "Vihaan", "Arjun", "Sai"];
        // center near Pahalgam: lat ~34.011, lng ~75.315
        const lat = 34.011 + (Math.random() - 0.5) * 0.06;
        const lng = 75.315 + (Math.random() - 0.5) * 0.08;
        return { id: `T-${id.toString().padStart(4, '0')}`, name: `${names[Math.floor(Math.random() * names.length)]} ${String.fromCharCode(65 + Math.floor(Math.random() * 26))}.`, lat, lng, dLat: (Math.random() - 0.5) * 0.0003, dLng: (Math.random() - 0.5) * 0.0003, status: 'safe', battery: Math.floor(Math.random() * 80) + 20 };
    }
    
    function createAlert(type, details, tourist) {
        tourist.status = 'distress';
        const newAlert = { id: `A-${String(state.alerts.length + 1).padStart(3, '0')}`, type, details, touristId: tourist.id, timestamp: new Date(), status: 'New' };
        state.alerts.unshift(newAlert);
        updateAlertsTable();
    }
    
    function initSimulation() {
        for (let i = 0; i < 50; i++) { state.tourists.push(createTourist(i)); }
        totalTouristsEl.textContent = state.tourists.length;
        // Add some convoys, police stations and hospitals
        mapState.convoys = [ { id: 'C-1', lat: 34.015, lng: 75.32 }, { id: 'C-2', lat: 34.002, lng: 75.305 } ];
        mapState.police = [ { id: 'P-1', lat: 34.018, lng: 75.31 } ];
        mapState.hospitals = [ { id: 'H-1', lat: 34.008, lng: 75.33 } ];
        searchIndex = buildSearchIndex();
        setInterval(simulationTick, 100);
        // initialize TomTom map (if key provided)
        initTomTomMap();
    }

    function simulationTick() {
        state.tourists.forEach(t => {
            t.lat += t.dLat; t.lng += t.dLng;
            if (t.lat < 33.98 || t.lat > 34.04) t.dLat *= -1;
            if (t.lng < 75.27 || t.lng > 75.355) t.dLng *= -1;
        });
        if (Math.random() < 0.005) {
            const safeTourist = state.tourists.find(t => t.status === 'safe');
            if (safeTourist) createAlert('Anomaly', 'Irregular Movement Detected', safeTourist);
        }
        renderMap();
        if (mapState.map) renderAllMarkersOnMap();
    }
    
    // --- RENDERING ---
    function renderMap() {
        mapElementsContainer.innerHTML = '';
        state.tourists.forEach(t => {
            const marker = document.createElement('div');
            marker.className = 'map-marker';
            if (t.status === 'distress') marker.classList.add('pulse');
            marker.innerHTML = `<i data-lucide="user" style="color: ${t.status === 'distress' ? 'var(--red-500)' : 'var(--green-500)'}; width: 28px; height: 28px;"></i>`;
            const pctX = ((t.lng - 75.27) / (75.355 - 75.27)) * 100;
            const pctY = ((34.04 - t.lat) / (34.04 - 33.98)) * 100;
            marker.style.left = `${Math.min(98, Math.max(2, pctX))}%`; marker.style.top = `${Math.min(98, Math.max(2, pctY))}%`;
            marker.onclick = () => showDetails(t.id);
            mapElementsContainer.appendChild(marker);
        });
        // Fallback overlay markers for convoys/police/hospitals
        (mapState.convoys || []).forEach(c => {
            const el = document.createElement('div'); el.className = 'map-marker'; el.innerHTML = `<i data-lucide="truck" style="color:var(--cyan-600); width:26px; height:26px;"></i>`;
            const pctX = ((c.lng - 75.27) / (75.355 - 75.27)) * 100; const pctY = ((34.04 - c.lat) / (34.04 - 33.98)) * 100;
            el.style.left = `${Math.min(98, Math.max(2, pctX))}%`; el.style.top = `${Math.min(98, Math.max(2, pctY))}%`;
            mapElementsContainer.appendChild(el);
        });
        (mapState.police || []).forEach(p => {
            const el = document.createElement('div'); el.className = 'map-marker'; el.innerHTML = `<i data-lucide="shield" style="color:var(--blue-500); width:24px; height:24px;"></i>`;
            const pctX = ((p.lng - 75.27) / (75.355 - 75.27)) * 100; const pctY = ((34.04 - p.lat) / (34.04 - 33.98)) * 100;
            el.style.left = `${Math.min(98, Math.max(2, pctX))}%`; el.style.top = `${Math.min(98, Math.max(2, pctY))}%`;
            mapElementsContainer.appendChild(el);
        });
        (mapState.hospitals || []).forEach(h => {
            const el = document.createElement('div'); el.className = 'map-marker'; el.innerHTML = `<i data-lucide="cross" style="color:var(--red-500); width:24px; height:24px;"></i>`;
            const pctX = ((h.lng - 75.27) / (75.355 - 75.27)) * 100; const pctY = ((34.04 - h.lat) / (34.04 - 33.98)) * 100;
            el.style.left = `${Math.min(98, Math.max(2, pctX))}%`; el.style.top = `${Math.min(98, Math.max(2, pctY))}%`;
            mapElementsContainer.appendChild(el);
        });
        lucide.createIcons();
    }
    
    function updateAlertsTable() {
        alertsTableBody.innerHTML = '';
        state.alerts.forEach(a => {
            const row = document.createElement('tr');
            row.innerHTML = `<td>${a.id}</td><td>${a.type}</td><td>${a.details} (${a.touristId})</td><td>${a.timestamp.toLocaleTimeString()}</td><td><span class="status-badge status-new">${a.status}</span></td>`;
            alertsTableBody.appendChild(row);
        });
        activeAlertsEl.textContent = state.alerts.length;
    }
    
    function initAnalyticsChart() {
        const ctx = document.getElementById('alerts-chart').getContext('2d');
        state.charts.alerts = new Chart(ctx, {
            type: 'bar',
            data: { labels: ['SOS', 'Anomaly', 'Geofence Breach', 'Low Battery'], datasets: [{ label: 'Total Alerts by Type', data: [5, 12, 3, 8], backgroundColor: ['#ef4444', '#eab308', '#3b82f6', '#f97316'] }] },
            options: { scales: { y: { beginAtZero: true } } }
        });
    }

    // --- START ---
    window.onload = initSimulation;
    </script>
</body>
</html>

